#!/usr/bin/env fish

if ! command -v fish &>/dev/null
    echo "Error: Fish could not be found! Please install." 1>&2
    exit 64
end

set -l DEST_PATH $HOME
set -l LINK_PATH "$(dirname (dirname (realpath (status current-filename))))/links"
set -l BACKUP_PATH $HOME/documents/throwaways/.backups/

set -l is_setup
read -l -P 'Setup or Uninstall  dotfiles? [S/u] ' run_type
switch $run_type
    case '' S s
        set is_setup true
    case U u
        set is_setup false
    case '*'
        echo -e 'Please select either setup or uninstall!\n'
        return
end

mkdir -p $BACKUP_PATH
for link in $LINK_PATH/{.,}*
    set -l target (readlink -f $link)
    set -l dest $DEST_PATH
    set -l target_name (basename $target)
    set -l symlink_path "$dest/$target_name"

    echo
    if [ -L $symlink_path ] # remove exist symlinks
        echo "Remove old symlink: $symlink_path"
        unlink $symlink_path

    else if [ -d $symlink_path ] || [ -f $symlink_path ] # remove/backup exist configs
        set -l backup_path "$BACKUP_PATH$target_name--$(uuidgen --time)"
        echo "Backup: $symlink_path --> $backup_path"
        mv $symlink_path $backup_path
    end


    echo "Set symlink: $target --> $symlink_path"
    ln -sf $target $dest
end
